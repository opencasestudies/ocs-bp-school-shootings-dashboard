---
title: "School Shooting Dashboard"
output: 
  flexdashboard::flex_dashboard:
    logo: https://icons.iconarchive.com/icons/icons8/windows-8/48/Military-Gun-icon.png
    theme: readable
    orientation: columns
    source: embed
    self_contained: TRUE
    vertical_layout: fill
runtime: shiny
---

```{r, echo=FALSE}
library(here)
library(flexdashboard)
library(shiny)
library(tidyverse)
library(leaflet)
library(sf)
library(rmapshaper)
library(htmltools)
library(lubridate)
library(DT)
```

The Data {data-icon="fa-database"}
===================================== 

```{r, echo=FALSE}
shooting_data_geocoded <- read_csv(here("processed_data",
              "shooting_data.csv"))

```

```{r, echo=FALSE}
shooting_data_geocoded <- shooting_data_geocoded %>%
  filter(!is.na(longitude),
         !is.na(latitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  st_transform(crs = 102008) %>%
  st_jitter(amount = 50) %>%
  st_transform(crs = 4326) %>%
  mutate(longitude = st_coordinates(.)[,1],
         latitude = st_coordinates(.)[,2]) %>%
  as_tibble() %>%
  dplyr::select(-geometry)

DT_table <- shooting_data_geocoded %>%
  dplyr::select(Date,
                School,
                City,
                State,
                `Narrative (Detailed Summary/ Background)`) %>%
  rename("Narrative" = `Narrative (Detailed Summary/ Background)`)

# Instead of depending on the st_jitter algorithm to generate random placement, a custom function placing the points side by side at a set distance could be used to make points occuring at the same location neatly apart.
```    

Column {data-width=700}
-------------------------------------

The data is from the K-12 school shooting database. This database was compiled using several steps to identify and authenticate incidents. Methods are outlined [here](https://www.chds.us/ssdb/methods/).

[TEXT]

###

```{r, echo=FALSE}
DT::renderDataTable({
  DT::datatable(DT_table,
                caption = htmltools::tags$caption(
                  style = 'caption-side: top; text-align: Left;',
                  htmltools::withTags(
                    div(HTML('<a href="https://www.chds.us/ssdb/dataset/)">Click here to be redirected to a page where this data can be downloaded.</a>')))),
                options = list(autoWidth = TRUE,
                               pageLength = 10,
                               scroller = TRUE,
                               scrollY = '450px'))
})
```

Column {data-width=300}
-------------------------------------

###

```{r, echo=FALSE, fig.cap="[Photograph by Rubén Rodriguez](https://unsplash.com/photos/IXTvnOOSTyU)", out.width = '100%'}
knitr::include_graphics("ruben-rodriguez-IXTvnOOSTyU-unsplash.jpg")
```

US Statistics {data-icon="fa-flag"}
===================================== 

Column {data-width=700 .tabset .tabset-fade}
-------------------------------------

### Yearly Deaths

```{r}
shooting_data_geocoded_us <- shooting_data_geocoded %>%
    mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
    mutate(Date_year = year(Date)) %>%
    group_by(Date_year) %>%
    count() %>%
    ungroup()
start <- 1970
end <- 2020
shooting_data_geocoded_us %>%
    ggplot(aes(x = Date_year, y = n)) +
    geom_bar(stat = "identity", fill = "black") +
    scale_x_continuous(breaks = seq(start, end, by = 5),
                 labels = seq(start, end, by = 5),
                 limits = c(start-1, end+1)) +
    theme_minimal() +
    labs(title = "Yearly Deaths Attributable to School Shootings",
         subtitle = "United States",
         x = "School Shootings",
         y = "")
```

### Yearly Cumulative Deaths

```{r}
start <- 1970
end <- 2020
shooting_data_geocoded_us2 <- shooting_data_geocoded %>%
    mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
    mutate(Date_year = year(Date)) %>%
    group_by(Date_year) %>%
    summarize(N = n()) %>%
    ungroup() %>%
    complete(Date_year = seq(start,end,by=1)) %>%
    mutate(n_cumsum = cumsum(N))
shooting_data_geocoded_us2 %>%
    ggplot(aes(x = Date_year, y = n_cumsum)) +
    geom_bar(stat = "identity", fill = "black") +
    scale_x_continuous(breaks = seq(start, end, by = 5),
                 labels = seq(start, end, by = 5),
                 limits = c(start-1, end+1)) +
    theme_minimal() +
    labs(title = "Yearly Cumulative Deaths Attributable to School Shootings",
         subtitle = "United States",
         x = "School Shootings",
         y = "")
```

### Deaths per Shooting

```{r}
shooting_data_geocoded_us3 <- shooting_data_geocoded %>%
    mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
    mutate(Date_year = year(Date)) %>%
    group_by(`Killed (includes shooter)`) %>%
    summarize(N = n())
shooting_data_geocoded_us3 %>%
    ggplot(aes(x = `Killed (includes shooter)`, y = N)) +
    geom_bar(stat = "identity", fill = "black") +
  scale_x_continuous(breaks = seq(0,10, by = 1),
                     labels = seq(0,10, by = 1),
                     limits = c(-1,10)) +
  scale_y_continuous() +
    theme_minimal() +
    labs(title = "Deaths per School Shooting",
         subtitle = "United States",
         x = "School Shootings",
         y = "")
```

Column {data-width=300}
------------------------------------- 

### **Wounded**
    
```{r}
valueBox(sum(shooting_data_geocoded$Wounded, na.rm = TRUE),
         color = "white")
```
    
### **Deaths**

```{r}
valueBox(sum(shooting_data_geocoded$`Killed (includes shooter)`, na.rm = TRUE),
         color = "white")
```

### **Shooter Completed/Attempted Suicide**

```{r}
# this needs to be wrangled in the regular data
suicide <- shooting_data_geocoded %>%
  mutate(`Suicide (or attempted suicide) by Shooter (Y/N)` = case_when(`Suicide (or attempted suicide) by Shooter (Y/N)` == "Yes" ~ TRUE,
                                                                       TRUE ~ FALSE)) %>%
  pull(`Suicide (or attempted suicide) by Shooter (Y/N)`)

suicide <- sum(suicide,
               na.rm = TRUE) / length(suicide)

# valueBox(
#   paste(
#     round(
#       mean(suicide,
#            na.rm = TRUE) * 100,
#       2),
#     "%"),
#   color = "white")

valueBox(
  paste(
    round(suicide * 100,
          2),
  "%"),
  color = "white")
```

### **Median Shots Fired**

```{r}
valueBox(
  round(
  median(shooting_data_geocoded$`Number of Shots Fired`,
      na.rm = TRUE),
  2),
  color = "white")
```

### **Deaths, Shooter was Only Victim**

```{r}
valueBox(
  paste(
    as.character(
    round(
      100 * (sum(
    ifelse(shooting_data_geocoded$`Suicide (Shooter was only victim) Y/N/ N/A` == "Y",
                TRUE,
                FALSE), na.rm = TRUE)
    /
      sum(shooting_data_geocoded$`Killed (includes shooter)`, na.rm = TRUE)),
    2)), "%"),
  color = "white")
```

### **Median Shots Fired**

```{r}
valueBox(
  round(
  median(shooting_data_geocoded$`Number of Shots Fired`,
      na.rm = TRUE),
  2),
  color = "white")
```

State Statistics {data-icon=fa-flag-checkered}
===================================== 

Column {.sidebar data-width=250}
-----------------------------------------------------------------------

```{r}
selectInput("state_selected", label = "Select a state to explore:",
            choices = unique(map_data("state") %>%
                               filter(region!="district of columbia") %>%
                               pull(region)) %>%
              str_to_title(), selected = "Maryland")
```

Column {data-width=750 .tabset .tabset-fade}
-----------------------------------------------------------------------

### Yearly Deaths

```{r}
renderPlot({
  start <- 1970
  end <- 2020
  state_df <- as_tibble(cbind(state.abb, state.name))
  shooting_data_geocoded <- shooting_data_geocoded %>%
    rename("State_abb" = State) %>%
    left_join(state_df, by = c("State_abb" = "state.abb")) %>%
    rename("State" = state.name) %>%
    mutate(State = str_to_title(tolower(State))) %>%
    mutate(Date = as.Date(Date, format = "%m/%d/%Y")) # this must be applied to wrangling
  shooting_data_geocoded_f <- shooting_data_geocoded[shooting_data_geocoded$State == input$state_selected, ]
  shooting_data_geocoded_f <- shooting_data_geocoded_f %>%
    mutate(Date_year = year(Date)) %>%
    group_by(Date_year) %>%
    count() %>%
    ungroup()
  shooting_data_geocoded_f %>%
    ggplot(aes(x = Date_year, y = n)) +
    geom_bar(stat = "identity", fill = "black") +
    scale_x_continuous(breaks = seq(start, end, by = 5),
                 labels = seq(start, end, by = 5),
                 limits = c(start-1, end+1)) +
    theme_minimal() +
    labs(title = "Statewide School Shootings",
         subtitle = input$state_selected,
         x = "Yearly Deaths Attributable to School Shootings",
         y = "")
})
```

### Yearly Cumulative Deaths

```{r}
renderPlot({
  start <- 1970
  end <- 2020
  state_df2 <- as_tibble(cbind(state.abb, state.name))
  shooting_data_geocoded2 <- shooting_data_geocoded %>%
    rename("State_abb" = State) %>%
    left_join(state_df2, by = c("State_abb" = "state.abb")) %>%
    rename("State" = state.name) %>%
    mutate(State = str_to_title(tolower(State))) %>%
    mutate(Date = as.Date(Date, format = "%m/%d/%Y")) # this must be applied to wrangling
  shooting_data_geocoded_f2 <- shooting_data_geocoded2[shooting_data_geocoded2$State == input$state_selected, ]
  shooting_data_geocoded_f2 <- shooting_data_geocoded_f2 %>%
    mutate(Date_year = year(Date)) %>%
    group_by(Date_year) %>%
    summarize(N = n()) %>%
    ungroup() %>%
    complete(Date_year = seq(start, end, by=1),
             fill = list(N = 0)) %>%
    mutate(n_cumsum = cumsum(N))
  shooting_data_geocoded_f2 %>%
    ggplot(aes(x = Date_year, y = n_cumsum)) +
    geom_bar(stat = "identity", fill = "black") +
    scale_x_continuous(breaks = seq(start, end, by = 5),
                 labels = seq(start, end, by = 5),
                 limits = c(start-1, end+1)) +
    theme_minimal() +
    labs(title = "Yearly Cumulative Deaths Attributable to School Shootings",
         subtitle = input$state_selected,
         x = "School Shootings",
         y = "")
})
```

### Deaths per Shooting

```{r}
renderPlot({
  state_df3 <- as_tibble(cbind(state.abb, state.name))
  shooting_data_geocoded3 <- shooting_data_geocoded %>%
    rename("State_abb" = State) %>%
    left_join(state_df3, by = c("State_abb" = "state.abb")) %>%
    rename("State" = state.name) %>%
    mutate(State = str_to_title(tolower(State)))
  shooting_data_geocoded3 <- shooting_data_geocoded3 %>%
    mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
    mutate(Date_year = year(Date)) %>%
    group_by(State,`Killed (includes shooter)`) %>%
    summarize(N = n())
  shooting_data_geocoded_f3 <- shooting_data_geocoded3[shooting_data_geocoded3$State == input$state_selected, ]
  shooting_data_geocoded_f3 %>%
    ggplot(aes(x = `Killed (includes shooter)`, y = N)) +
    geom_bar(stat = "identity", fill = "black") +
  scale_x_continuous(breaks = seq(0,30, by = 1),
                     labels = seq(0,30, by = 1),
                     limits = c(-1,30)) +
  scale_y_continuous() +
    theme_minimal() +
    labs(title = "Deaths per School Shooting",
         subtitle = input$state_selected,
         x = "School Shootings",
         y = "")
})
```

Map {data-icon="fa-map"}
===================================== 

```{r, echo=FALSE, eval=FALSE}
#this should be deleted after being placed at the top of the case study

shooting_data <- shooting_data %>%
  mutate(address = str_c(School, City, State, sep = " "))

shooting_data <- shooting_data %>%
  mutate(coords =geocode(address, output = c("latlon"),
                         source = c("google")))

shooting_data <- shooting_data %>%
  mutate(longitude = shooting_data$coords$lon,
         latitude = shooting_data$coords$lat) %>%
  dplyr::select(-coords)

write_csv(shooting_data, path = here("processed_data",
                              "shooting_data.csv"))
```

Column {data-width=1000}
------------------------------------- 
    
### 
    
```{r}
# would be a great idea to add a slider here if possible
# good site for icons https://iconarchive.com/

shooting_information0 <- paste('<div style="height:auto;line-height:1em;overflow:visible;padding:5px;">',
                              shooting_data_geocoded$Date,
                              "<b>",
                              shooting_data_geocoded$School,
                              "</b>",
                              shooting_data_geocoded$`Narrative (Detailed Summary/ Background)`,
                              "</div>",
                              sep = "<br/>"
)

# icon_set <- icons(
#   iconUrl = case_when(shooting_data_geocoded$`Firearm Type`=="Handgun" ~ "https://icons.iconarchive.com/icons/icons8/windows-8/48/Military-Gun-icon.png",
#                       shooting_data_geocoded$`Firearm Type`=="Rifle" ~ "https://icons.iconarchive.com/icons/icons8/windows-8/48/Military-Rifle-icon.png",
#                       TRUE ~ "https://icons.iconarchive.com/icons/dryicons/aesthetica-2/48/page-search-icon.png"),
#   iconWidth = 20,
#   iconHeight = 20
# )

leaflet(shooting_data_geocoded) %>%
  addProviderTiles(provider = providers$OpenStreetMap, group = "OpenStreetMap") %>%
  addProviderTiles(provider = providers$Esri.WorldImagery, group = "ESRI World Imagery") %>%
  addProviderTiles(provider = providers$Stamen.TonerLite, group = "Toner Lite") %>%
  addCircleMarkers(popup = ~shooting_information0,
                   lng = ~longitude,
                   lat = ~latitude,
    radius = 5,
    color = "red",
    fillOpacity = 0.2,
    stroke = TRUE,
    clusterOptions = markerClusterOptions(),
    group = "Circles (Radius &alpha; Killed)") %>%
  # addMarkers(lng = ~longitude,
  #                  lat = ~latitude,
  #            popup = ~shooting_information0,
  #                  icon = icon_set,
  #                  group = "TESTER") %>%
  addMiniMap(tiles = providers$Stamen.Toner,
             toggleDisplay = TRUE,
             minimized = FALSE) %>%
  addLayersControl(
    baseGroups = c("Toner Lite",
                   "OpenStreetMap",
                   "ESRI World Imagery"),
    overlayGroups = c("Circles (Radius &alpha; Killed)"),
    # overlayGroups = c("Circles (Radius &alpha; Killed)", "TESTER"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
  setView(lng = -98.35, lat = 39.5, zoom = 4)
# hideGroup(c("Circles (Radius &alpha; Killed)", "TESTER"))
# need to jitter coordinates by a few meters for repeats
```

About {data-icon="fa-question-circle"}
===================================== 

Column {data-width=700}
-------------------------------------

###

**What is the purpose of this dashboard?**

This dashboard has two purposes:

+ Illustrate trends in school shootings
+ Demonstrate how to create a dashboard using `R`

**I want to learn how to create a dashboard just like this.**

Visit the *Tutorial* page of this dashboard to first learn the basics about building a dashboard.

At the end of the tutorial we provide a link to this [supplementary resource by the Open Case Studies project](INCLUDE LINK HERE).

We have included the source code (see upper right-hand corner) in this dashboard for more experienced `R` users looking to mimic some of what we did in this dashboard in their own.

**Disclaimer**

The purpose of the [Open Case Studies](https://opencasestudies.github.io){target="_blank"} project is **to demonstrate the use of various data science methods, tools, and software in the context of messy, real-world data**.

A given case study does not cover all aspects of the research process, is not claiming to be the most appropriate way to analyze a given data set, and should not be used in the context of making policy decisions without external consultation from scientific experts. 

Column {data-width=300}
-------------------------------------

###

```{r, echo=FALSE, fig.cap="[Photograph by Rubén Rodriguez](https://unsplash.com/photos/IXTvnOOSTyU)", out.width = '100%'}
knitr::include_graphics("nathan-dumlao-xPHmmVKS8lM-unsplash.jpg")
```

Tutorial {.storyboard data-icon="fa-list-ol"}
=========================================   

### **1)** Load the `flexdashboard` package.

Install the package if you don't have the package installed already

```{r, echo=TRUE, eval=FALSE}
install.packages("flexdashboard")
install.packages("shiny")
```

Once installed, the package is ready to be loaded into the `R` environment.

```{r, echo=TRUE}
library(flexdashboard)
library(shiny)
```

This all needs to be done separately in the `R` console.

### **2)** Create an `RMD` document.   

Dashboards can be created with `flexdashboard` in the `HTML` format. 

`flexdashboard` uses `RMarkdown` to produce dashboards that can contain `R` output.

This makes it possible to include several mediums in our dashboard such as plots created with `ggplot` or maps created with `leaflet`.
    
### **3)** Create an appropriate `YAML`.

The use of `flexdashboard` alters the way `RMarkdown` documents function. These altered functions are largely dependent on the metadata we use to produce the dashboard. Metadata for the dashboard can be configured in the `YAML` of the `RMD`. 

An `HTML` document created with `RMarkdown` includes a `YAML` that is some variation of this:

```
---
title: "Untitled"
author: "Michael Ontiveros"
date: "8/12/2020"
output: html_document
---
```

We used the following `YAML` for this dashboard:

```
output: 
  flexdashboard::flex_dashboard:
    logo: https://icons.iconarchive.com/icons/icons8/windows-8/48/Programming-Dashboard-icon.png
    theme: readable
    orientation: columns
    source: embed
    vertical_layout: fill
runtime: shiny
```

We introduce an icon, provide a theme with a color scheme, define the orientation (and thus order) of coded output, include the code used, limit scrolling, and allow `shiny` widgets to be used.

### **4)** Design the layout of the dashboard.

Dashboards are inherently visual, making this step the most time intensive after content creation. We need to present the data in a way that is both meaning and visually appealing.

On this dashboard, we wanted to present static plots of the United States and of individual states. We also wanted to display the locations of school shootings and provide some information about school shootings. Aside from being a dashboard, we wanted to create an educational resource that was reproducible for others. Lastly, as a sensitive topic, we wanted to raise awareness and provide information that could help others act.

Given these goals, we decided on the following page layout:

+ The Data
+ US Statistics
+ State Statistics
+ Map
+ About
+ Tutorial
+ Hotline
+ Source Code

This layout ensured that we did to not include too many components.

The first page gives users to the opportunity to look at the data themselves. More complicated components such as the map of each incident were left alone on a single page. US and state-level statistics were separated from one another. This short tutorial on how to create the dashboard and source code were included in the dashboard with programmers at all levels in mind. The goals of the dashboard and actionable information were each given separate pages from the output. 

For your dashboard, this may take as long as the output you would like to share took you to produce. 

### **5)** Add content to the dashboard.

You can begin adding content to the dashboard once you have an initial layout in mind. Keep in mind that this will likely be an iterative process. 

The `RMarkdown` file used to create a dashboard with `flexdashboard` works similarly to any other `RMarkdown`. 

There are some exceptions. Most notably...

```{r, echo = TRUE}
# This output was created with chunk options: {r, echo = TRUE}
paste("Code chunks can be explicitly included")
```

```{r}
# This output was created with chunk options: {r}
paste("Code chunks are hidden by default")
```

Pages and columns within pages can be defined.

```
Page
=========================================   

Column {data-width=500}
-------------------------------------

Column {data-width=500}
-------------------------------------
```

As mentioned before, the `flexdashboard` metadata included in the `YAML` does also alter how `RMarkdown` functions. For more on how you can leverage both `RMarkdown` and `flexdashboard` to produce a dashboard, click [here](https://rmarkdown.rstudio.com/flexdashboard/index.html).

This [supplementary resource by the Open Case Studies project](INCLUDE LINK HERE) provides a case study on how to create this very dashboard in more detail.

Hotline {data-icon="fa-exclamation-triangle"}
=========================================   

Column {data-width=600}
-------------------------------------

###

**Warning Signs**

From [Sandy Hook Promise](https://www.sandyhookpromise.org/gun-violence/know-the-signs-of-gun-violence/)...

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

Here is a list of potential warning signs that can signal an individual may be in crisis and/or need help:

+ Suddenly withdrawing from people and activities
+ Consistent bullying or intimidating others, or being bullied by others
+ Extreme mood or personality changes
+ Victim of constant social rejection
+ Talking about plans or actively making plans to harm themselves or others
+ Bringing a weapon to school – or threatening or talking about doing so
+ Bragging about or warning others about an upcoming act of violence
+ Recruiting others to join in a planned act of violence
+ Warning students to stay away from school or events
+ Expressing fascination with guns and/or school shootings
+ Expressing hopelessness about the future
+ Extreme, prolonged sadness or distress
+ Expressing or showing feelings of isolation
+ Bragging about access to guns

**NOTE**

This list is not a comprehensive list of warning signs nor does exhibiting one of these signs indicate imminent violence.

When concerned about seeing troubling behaviors, tell a trusted adult or call 911, if there is an immediate threat.

</div>

Column {data-width=400}
-------------------------------------

### 

**Respond to Warning Signs**

Call 911 if you feel there is an immediate threat. 

Call [+1-844-5-SAYNOW](tel:18445729669) if you would to submit an anonymous safety concern.
